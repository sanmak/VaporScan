name: PR Quality Gate

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  quality-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Run format check
        id: format
        run: npm run format:check
        continue-on-error: true

      - name: Run type checking
        id: typecheck
        run: npm run type-check
        continue-on-error: true

      - name: Run unit tests
        id: unit
        run: npm run test:unit
        continue-on-error: true

      - name: Run integration tests
        id: integration
        run: npm run test:integration
        continue-on-error: true

      - name: Generate coverage
        run: npm run test:coverage:all
        continue-on-error: true

      - name: Build application
        id: build
        run: npm run build
        continue-on-error: true

      - name: Create PR comment with results
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = {
              lint: '${{ steps.lint.outcome }}',
              format: '${{ steps.format.outcome }}',
              typecheck: '${{ steps.typecheck.outcome }}',
              unit: '${{ steps.unit.outcome }}',
              integration: '${{ steps.integration.outcome }}',
              build: '${{ steps.build.outcome }}'
            };

            const statusEmoji = (status) => status === 'success' ? 'âœ…' : 'âŒ';

            const comment = `## ðŸ” PR Quality Gate Results

            | Check | Status |
            |-------|--------|
            | Linting | ${statusEmoji(results.lint)} ${results.lint} |
            | Formatting | ${statusEmoji(results.format)} ${results.format} |
            | Type Checking | ${statusEmoji(results.typecheck)} ${results.typecheck} |
            | Unit Tests | ${statusEmoji(results.unit)} ${results.unit} |
            | Integration Tests | ${statusEmoji(results.integration)} ${results.integration} |
            | Build | ${statusEmoji(results.build)} ${results.build} |

            ${Object.values(results).every(r => r === 'success')
              ? '### âœ… All checks passed! This PR is ready for review.'
              : '### âŒ Some checks failed. Please review the errors above.'}

            ---
            *Generated by GitHub Actions*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Quality Gate Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if any check failed
        if: |
          steps.lint.outcome != 'success' ||
          steps.format.outcome != 'success' ||
          steps.typecheck.outcome != 'success' ||
          steps.unit.outcome != 'success' ||
          steps.integration.outcome != 'success' ||
          steps.build.outcome != 'success'
        run: exit 1

  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage report
        run: npm run test:coverage:all

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: pr-check
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Comment coverage on PR
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  size-limit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Check bundle size
        run: |
          echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          du -sh out/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Largest Files:" >> $GITHUB_STEP_SUMMARY
          find out/_next/static -type f -exec du -h {} + | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
